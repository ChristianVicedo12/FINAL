@page
@model IskoWalk.Pages.MyRequestsHistoryModel
<link rel="stylesheet" href="~/css/myrequests.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<div class="dashboard">

    @* SIDEBAR *@
    <aside class="sidebar">
        <div class="brand">
            <img src="~/images/IskoWalk.png" />
            <span>ISKOWALK</span>
        </div>

        <nav class="menu">
            <a asp-page="/Dashboard">
                <i class="fa-solid fa-house"></i>Dashboard
            </a>

            <a asp-page="/MyRequestsActive">
                <i class="fa-solid fa-file-lines"></i>My Requests
            </a>

            <a asp-page="/Profile">
                <i class="fa-solid fa-user"></i>Profile
            </a>
        </nav>

        <div class="user-box" id="profileBtn">
            <img src="~/images/IskoWalk.png" />
            <div class="user-info">
                <strong id="sidebarUsername">Loading...</strong>
                <span>Student</span>
            </div>
            <i class="fa-solid fa-chevron-down"></i>
        </div>

        <div class="dropdown" id="dropdownMenu">
            <div class="dropdown-user">
                <strong id="dropdownUsername">Loading...</strong>
                <small id="dropdownEmail">Loading...</small>
            </div>
            <hr />
            <a id="logoutBtn" onclick="handleLogout()" style="cursor: pointer;"><i class="fa-solid fa-right-from-bracket"></i> Log out</a>
        </div>
    </aside>

    <main class="content">

        <div class="topbar">
            <div class="directory">Dashboard › My Requests › <b>History</b></div>
            <a asp-page="/Create" class="btn-main"><i class="fa-solid fa-plus"></i> New Request</a>
        </div>

        <div class="divider"></div>

        <h2>My Activity</h2>
        <p class="subtitle">Track the requests you've created, the walks you've accepted, and view your activity history.</p>

        <div class="tabs">
            <a asp-page="/MyRequestsActive" class="tab">Active Request</a>
            <a asp-page="/MyRequestsAccepted" class="tab">Accepted Request</a>
            <button class="tab active">History</button>
        </div>

        <div id="loadingState" style="text-align: center; padding: 40px;">
            <i class="fa-solid fa-spinner fa-spin" style="font-size: 2rem;"></i>
            <p>Loading history...</p>
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <p class="title">No history yet.</p>
            <p class="subtitle">Once your walks are completed, they will appear here.</p>
        </div>

        <div id="historyBox" class="history-box" style="display: none;">
            <div class="history-header">
                <div>Route</div>
                <div>Date</div>
                <div>Your Role</div>
                <div>Outcome</div>
            </div>
            <div id="historyRows"></div>
        </div>

        <div id="detailsModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h2>Walk Request Details</h2>
                        <p id="modalCreatedDate">Requested on December 31, 2025</p>
                    </div>
                </div>

                <div class="modal-body">
                    <div class="modal-row user-row grid-2">
                        <div class="user-info-block align">
                            <i class="fa-solid fa-user-tag icon-circle"></i>
                            <div class="user-text-column">
                                <span>Requester</span>
                                <div class="user-name-row">
                                    <div class="avatar-circle"></div>
                                    <strong id="modalRequesterName">Juan Dela Cruz</strong>
                                </div>
                            </div>
                        </div>

                        <div id="companionInfo" class="user-info-block align">
                            <i class="fa-solid fa-handshake icon-circle"></i>
                            <div class="user-text-column">
                                <span>Companion</span>
                                <div class="user-name-row">
                                    <div class="avatar-circle"></div>
                                    <strong id="modalCompanionName">Jose Rizal</strong>
                                </div>
                                <small id="modalCompanionContact"><i class="fa-solid fa-phone"></i> 09999992737</small>
                            </div>
                        </div>
                    </div>

                    <div class="modal-row">
                        <i class="fa-solid fa-location-dot icon-circle"></i>
                        <div>
                            <strong>Route</strong>
                            <p id="modalFromLocation">From: <b>Main Building (Lobby near the stairs)</b></p>
                            <p id="modalToLocation">To: <b>Pureza LRT Station</b></p>
                        </div>
                    </div>

                    <div class="modal-row grid-2">
                        <div class="info-group">
                            <i class="fa-regular fa-clock icon-circle"></i>
                            <div>
                                <strong>Date & Time</strong>
                                <p id="modalDateTime">Wednesday, December 31 at 10:29PM</p>
                            </div>
                        </div>
                        <div class="info-group">
                            <i class="fa-solid fa-shirt icon-circle"></i>
                            <div>
                                <strong>Attire Description</strong>
                                <p id="modalAttire">Wearing a white shirt and basta kapag maganda, me nayan</p>
                            </div>
                        </div>
                    </div>

                    <div class="modal-row">
                        <i class="fa-solid fa-pen icon-circle"></i>
                        <div>
                            <strong>Additional Notes</strong>
                            <p id="modalNotes">Late ako konti hehe. Ayoko ko naghihintay</p>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeModal('detailsModal')">Close</button>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    let allHistory = [];
    let currentHistoryId = null;

    const btn = document.getElementById("profileBtn");
    const menu = document.getElementById("dropdownMenu");

    btn.onclick = () => menu.classList.toggle("show");

    document.addEventListener("click", e => {
        if(!btn.contains(e.target) && !menu.contains(e.target)){
            menu.classList.remove("show");
        }
    });

    // ✅ Check authentication
    function checkAuth() {
        const token = sessionStorage.getItem('token');
        if (!token) {
            console.error('No token found - redirecting to login');
            window.location.href = '/Index';
            return false;
        }
        return true;
    }

    // Load user info
    function loadUserInfo() {
        const username = sessionStorage.getItem('username');
        const email = sessionStorage.getItem('email');
        
        if (username) {
            document.getElementById('sidebarUsername').textContent = username;
            document.getElementById('dropdownUsername').textContent = username;
        }
        if (email) {
            document.getElementById('dropdownEmail').textContent = email;
        }
    }

    // Format time
    function formatTime(timeSpan) {
        if (!timeSpan) return 'Not specified';
        const parts = timeSpan.split(':');
        let hours = parseInt(parts[0]);
        const minutes = parts[1];
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12 || 12;
        return `${hours}:${minutes} ${ampm}`;
    }

    // Format date
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    }

    // Format history date (shorter)
    function formatHistoryDate(dateString, timeSpan) {
        const date = new Date(dateString);
        const dateStr = date.toLocaleDateString('en-US', { 
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });
        return `${dateStr} ${formatTime(timeSpan)}`;
    }

    // ✅ Load history from backend
    async function loadHistory() {
        try {
            const token = sessionStorage.getItem('token');
            const userId = sessionStorage.getItem('userId');
            
            if (!token) {
                window.location.href = '/Index';
                return;
            }

            console.log('Fetching history...');
            
            const response = await fetch('http://localhost:5012/api/WalkRequest/history', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            console.log('Response status:', response.status);

            if (response.status === 401) {
                sessionStorage.clear();
                window.location.href = '/Index';
                return;
            }
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const history = await response.json();
            allHistory = history;
            console.log('History:', history);

            document.getElementById('loadingState').style.display = 'none';

            if (!history || history.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            const historyBox = document.getElementById('historyBox');
            const historyRows = document.getElementById('historyRows');
            historyBox.style.display = 'block';

            historyRows.innerHTML = history.map(item => {
                // Determine role based on userId
                const role = item.userId === parseInt(userId) ? 'Requester' : 'Companion';
                
                // Determine status class
                const statusClass = item.status === 'Completed' ? 'completed' : 'failed';
                const statusText = item.status === 'Completed' ? 'Completed' : 'Cancelled';

                return `
                    <div class="history-row" onclick="openDetails(${item.id})">
                        <div>${item.fromLocation} → ${item.toDestination}</div>
                        <div>${formatHistoryDate(item.dateOfWalk, item.timeOfWalk)}</div>
                        <div><span class="role-badge">${role}</span></div>
                        <div><span class="status ${statusClass}">${statusText}</span></div>
                    </div>
                `;
            }).join('');

        } catch (error) {
            console.error('Error loading history:', error);
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }
    }

    // Open details modal
    function openDetails(historyId) {
        const item = allHistory.find(h => h.id === historyId);
        if (!item) {
            console.error('History item not found:', historyId);
            return;
        }

        currentHistoryId = historyId;

        document.getElementById('modalRequesterName').textContent = item.requesterName || 'Unknown';
        document.getElementById('modalCompanionName').textContent = item.companionName || 'Unknown';
        document.getElementById('modalCompanionContact').innerHTML = item.companionContact 
            ? `<i class="fa-solid fa-phone"></i> ${item.companionContact}` 
            : '';
        document.getElementById('modalFromLocation').innerHTML = `From: <b>${item.fromLocation}${item.specifyOrigin ? ' (' + item.specifyOrigin + ')' : ''}</b>`;
        document.getElementById('modalToLocation').innerHTML = `To: <b>${item.toDestination}</b>`;
        document.getElementById('modalDateTime').textContent = `${formatDate(item.dateOfWalk)} at ${formatTime(item.timeOfWalk)}`;
        document.getElementById('modalAttire').textContent = item.attireDescription || 'No description provided';
        document.getElementById('modalNotes').textContent = item.additionalNotes || 'No additional notes';
        document.getElementById('modalCreatedDate').textContent = `Requested on ${formatDate(item.createdAt)}`;

        document.getElementById('detailsModal').style.display = 'flex';
    }

    // Close modal
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // Handle logout
    function handleLogout() {
        sessionStorage.clear();
        localStorage.clear();
        window.location.href = '/Index';
    }

    // ✅ Load on page load
    document.addEventListener('DOMContentLoaded', () => {
        if (checkAuth()) {
            loadUserInfo();
            loadHistory();
        }
    });
</script>
